<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Object Customizer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“±</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Unbounded:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Lucide icons for UI glyphs -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #1a1a1a;
            color: #e5e5e5;
            overflow: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Unbounded', sans-serif;
            font-weight: 800;
        }

        /* Header */
        .header {
            height: 64px;
            background: #2a2a2a;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            border-radius: 0;
            box-shadow: none;
            z-index: 100;
        }

        .header-container {
            width: 100%;
            max-width: 1920px;
            margin: 0 auto;
            padding: 0 3rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .nav {
            display: flex;
            align-items: center;
            gap: 3rem;
            flex: 1;
        }

        .logo {
            font-family: 'Unbounded', sans-serif;
            font-size: 1.5rem;
            font-weight: 900;
            letter-spacing: -0.05em;
            color: #e5e5e5;
            text-transform: uppercase;
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-link {
            font-size: 0.875rem;
            font-weight: 700;
            color: #888888;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 0;
            transition: all 0.15s;
            cursor: pointer;
            background: transparent;
            border: none;
            outline: none;
            outline-offset: 0;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 1rem;
            right: 1rem;
            height: 2px;
            background: transparent;
            transition: all 0.15s;
        }

        .nav-link:hover::after {
            background: #888888;
        }

        .nav-link:focus {
            outline: 2px solid #9333ea;
            outline-offset: 2px;
        }

        .nav-link.active {
            color: #9333ea;
            background: transparent;
        }

        .nav-link.active::after {
            background: #9333ea;
        }

        .header-icons {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0;
            color: #888888;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 1.125rem;
            border: none;
            outline: 2px solid transparent;
            outline-offset: 0;
        }

        .header-icon:hover {
            background: #2a2a2a;
            color: #e5e5e5;
            outline-color: #3a3a3a;
        }

        .user-account {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: #2a2a2a;
            border-radius: 0;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            cursor: pointer;
            transition: all 0.15s;
        }

        .user-account:hover {
            background: #333333;
            outline-color: #4a4a4a;
        }

        .user-account:focus {
            outline: 2px solid rgba(255, 255, 255, 0.3);
            outline-offset: 2px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 0;
            background: #9333ea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8125rem;
            font-weight: 800;
            color: #ffffff;
            box-shadow: none;
            border: none;
            outline: 2px solid #a855f7;
            outline-offset: 0;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 700;
            color: #e5e5e5;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Main Container */
        .main-container {
            display: grid;
            grid-template-columns: minmax(0, 1.25fr) 480px;
            height: calc(100vh - 64px);
            width: 100%;
            margin-top: 64px;
            max-width: 100%;
            margin-left: 0;
            margin-right: 0;
            padding: 10px;
            gap: 10px;
        }

        /* Left: 2D Viewer */
        .viewer-section {
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-radius: 0;
            background: #2a2a2a;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            box-shadow: none;
            height: 100%;
        }

        .vehicle-dropdown {
            position: absolute;
            top: 2rem;
            left: 2rem;
            z-index: 10;
        }

        .dropdown-trigger {
            padding: 0.75rem 1.25rem;
            background: #1a1a1a;
            backdrop-filter: none;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            color: #e5e5e5;
            font-size: 0.875rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.875rem;
            transition: all 0.15s;
            box-shadow: none;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dropdown-trigger:hover {
            background: #2a2a2a;
            outline-color: #9333ea;
        }

        .dropdown-icon {
            transition: transform 0.2s;
        }

        .dropdown-trigger.open .dropdown-icon {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            min-width: 360px;
            background: #1a1a1a;
            backdrop-filter: none;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            padding: 4px;
            display: none;
            box-shadow: none;
        }

        .dropdown-menu.open {
            display: block;
        }

        .vehicle-category {
            margin-bottom: 0.5rem;
        }

        .category-title {
            font-size: 0.75rem;
            font-weight: 800;
            color: #888888;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0.5rem 0.75rem;
        }

        .vehicle-option {
            padding: 0.875rem 1rem;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border: none;
            outline: 2px solid transparent;
            outline-offset: 0;
        }

        .vehicle-option:hover {
            background: #2a2a2a;
            outline-color: #3a3a3a;
        }

        .vehicle-option.active {
            background: #9333ea;
            outline-color: #a855f7;
        }

        .vehicle-option:focus {
            outline: 2px solid #9333ea;
            outline-offset: 2px;
        }

        .vehicle-icon {
            font-size: 1.5rem;
        }

        .vehicle-info .name {
            font-size: 0.875rem;
            font-weight: 700;
            color: #e5e5e5;
        }

        .vehicle-info .type {
            font-size: 0.75rem;
            color: #888888;
            font-weight: 600;
        }

        #canvas-container {
            flex: 1;
            width: 100%;
            height: 100%;
            position: relative;
            border-radius: 0;
            overflow: auto;
            box-shadow: none;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background: #1a1a1a;
        }

        #svg-viewer {
            width: auto !important;
            height: calc(100vh - 200px) !important;
            max-width: none !important;
            max-height: calc(100vh - 200px) !important;
            min-width: 400px;
        }

        /* Color overlay over the Sketchfab viewer */
        #viewer-color-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            mix-blend-mode: multiply;
            opacity: 0.75;
            background: #f5f5f5;
            transition: background 0.2s ease, opacity 0.2s ease;
        }

        /* Right: Control Panel */
        .control-section {
            display: grid;
            grid-template-rows: auto 1fr auto;
            background: #2a2a2a;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
        }

        /* Fixed Pricing */
        .pricing-fixed {
            padding: 10px;
            background: #1a1a1a;
            backdrop-filter: none;
            border: none;
            border-bottom: none;
            position: relative;
        }

        .pricing-fixed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #3a3a3a;
        }

        .price-display {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin-bottom: 12px;
        }

        .price-amount {
            font-size: 3rem;
            font-weight: 900;
            letter-spacing: -0.05em;
            color: #9333ea;
        }

        .price-label {
            font-size: 0.875rem;
            color: #888888;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .price-details-toggle {
            background: none;
            border: none;
            color: #888888;
            font-size: 0.875rem;
            font-weight: 700;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.15s;
            outline: none;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .price-details-toggle:hover {
            color: #9333ea;
        }

        .price-details-toggle:focus {
            outline: 2px solid #9333ea;
            outline-offset: 2px;
            border-radius: 4px;
        }

        .price-breakdown {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 12px;
        }

        .price-breakdown.open {
            max-height: 400px;
        }

        .price-line {
            display: flex;
            justify-content: space-between;
            padding: 0.625rem 0;
            font-size: 0.875rem;
            color: #888888;
            font-weight: 600;
        }

        .price-divider {
            position: relative;
        }

        .price-divider::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: #3a3a3a;
        }

        .price-line .amount {
            font-weight: 800;
            color: #e5e5e5;
        }

        /* Scrollable Customization */
        .customization-panel {
            overflow-y: auto;
            padding: 10px;
            padding-bottom: 2rem;
            max-height: calc(100vh - 64px - 200px - 80px);
        }

        .customization-panel::-webkit-scrollbar {
            width: 8px;
        }

        .customization-panel::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 0;
        }

        .customization-panel::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 0;
            transition: background 0.15s;
        }

        .customization-panel::-webkit-scrollbar-thumb:hover {
            background: #9333ea;
        }

        /* Fixed Order Button Container */
        .order-button-container {
            padding: 10px;
            background: #1a1a1a;
            border-top: 2px solid #3a3a3a;
            position: relative;
            display: flex;
            align-items: center;
            min-height: 70px;
        }

        .section {
            margin-bottom: 12px;
        }

        .section-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 0.75rem;
            font-weight: 900;
            margin-bottom: 10px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #888888;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #9333ea;
            border-radius: 0;
        }

        /* Color Picker */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }

        .gradient-section {
            margin-top: 12px;
            margin-bottom: 12px;
        }

        .gradient-label {
            font-size: 0.75rem;
            font-weight: 800;
            color: #888888;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
        }

        .gradient-picker {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .gradient-color-input {
            flex: 1;
            height: 40px;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            cursor: pointer;
            background: #1a1a1a;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .gradient-color-input:hover {
            outline-color: #9333ea;
        }

        .gradient-preview {
            width: 100%;
            height: 60px;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .gradient-preview:hover {
            outline-color: #9333ea;
        }

        .color-swatch {
            aspect-ratio: 1;
            border-radius: 0;
            cursor: pointer;
            border: none;
            outline: 2px solid #666666;
            outline-offset: 0;
            transition: all 0.15s;
            box-shadow: none;
            position: relative;
        }

        .color-swatch::before {
            content: '';
            position: absolute;
            inset: 0;
            outline: 1px solid rgba(0, 0, 0, 0.2);
            outline-offset: -1px;
            pointer-events: none;
        }

        .color-swatch:hover {
            transform: none;
            outline-color: #9333ea;
            outline-width: 3px;
            box-shadow: none;
        }

        .color-swatch:focus {
            outline: 3px solid #9333ea;
            outline-offset: 0;
        }

        .color-swatch.active {
            outline-color: #9333ea;
            outline-width: 4px;
            box-shadow: none;
        }

        .color-swatch.gradient {
            background: linear-gradient(135deg, var(--gradient-start, #9333ea), var(--gradient-end, #a855f7));
        }

        /* Color Wheel Section */
        .color-picker-section {
            margin-bottom: 12px;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 12px;
        }

        .color-picker-input {
            width: 56px;
            height: 56px;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            cursor: pointer;
            background: #1a1a1a;
            padding: 0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            box-shadow: none;
            transition: all 0.15s;
        }

        .color-picker-input:hover {
            outline-color: #9333ea;
            box-shadow: none;
        }

        .color-picker-input::-webkit-color-swatch-wrapper {
            padding: 0;
            border: none;
            border-radius: 0;
        }

        .color-picker-input::-webkit-color-swatch {
            border: none;
            border-radius: 0;
        }

        .color-picker-input::-moz-color-swatch {
            border: none;
            border-radius: 0;
        }

        .color-preview {
            flex: 1;
            height: 56px;
            border-radius: 0;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 700;
            color: #e5e5e5;
            text-align: center;
            font-family: 'Inter', sans-serif;
            padding: 0 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .color-preview:focus {
            outline: 2px solid #9333ea;
            outline-offset: 2px;
            border-color: #9333ea;
            background: rgba(147, 51, 234, 0.1);
        }

        .color-preview::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        /* CMYK Inputs */
        .cmyk-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        .cmyk-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .cmyk-label {
            font-size: 0.75rem;
            font-weight: 800;
            color: #888888;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.625rem;
        }

        .cmyk-input-group {
            position: relative;
        }

        .cmyk-input {
            width: 100%;
            padding: 0.875rem;
            background: #1a1a1a;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.15s;
            box-shadow: none;
        }

        .cmyk-input:focus {
            outline-color: #9333ea;
            background: #2a2a2a;
            box-shadow: none;
        }

        .cmyk-input-wrapper {
            position: relative;
        }

        .cmyk-percent {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            color: rgba(245, 245, 245, 0.4);
            pointer-events: none;
            font-weight: 500;
        }


        /* Preset logos / patterns */
        .preset-section {
            margin-bottom: 12px;
        }

        .preset-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .preset-item {
            flex: 0 0 calc(50% - 5px);
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.75rem;
            background: #1a1a1a;
            border-radius: 0;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            cursor: pointer;
            transition: all 0.15s;
        }

        .preset-item:hover {
            background: #2a2a2a;
            outline-color: #9333ea;
            transform: none;
        }

        .preset-icon {
            width: 40px;
            height: 28px;
            border-radius: 0;
            background: #2a2a2a;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: #e5e5e5;
            overflow: hidden;
        }

        .preset-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: #e5e5e5;
        }

        .preset-subtext {
            font-size: 0.7rem;
            color: #888888;
            margin-top: 0.1rem;
            font-weight: 600;
        }

        .pattern-color-controls {
            margin-top: 12px;
            padding: 0.75rem 0.85rem;
            border-radius: 0;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .pattern-color-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: #e5e5e5;
        }

        .pattern-color-subtext {
            font-size: 0.7rem;
            color: #888888;
            font-weight: 600;
        }

        .pattern-color-picker {
            border-radius: 0;
            width: 42px;
            height: 24px;
            padding: 0;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            background: #1a1a1a;
            cursor: pointer;
        }

        /* File Upload */
        .file-upload-section {
            border: none;
            outline: 2px dashed #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            background: #1a1a1a;
        }

        .file-upload-section:hover {
            outline-color: #9333ea;
            outline-style: solid;
            background: #2a2a2a;
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }

        .upload-text {
            font-size: 0.875rem;
            color: #888888;
            margin-bottom: 0.25rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .upload-subtext {
            font-size: 0.75rem;
            color: #666666;
            font-weight: 600;
        }

        .files-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.875rem 1rem;
            background: #1a1a1a;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            box-shadow: none;
            transition: all 0.15s;
        }

        .file-item:hover {
            background: #2a2a2a;
            outline-color: #9333ea;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .file-icon {
            font-size: 1.25rem;
        }

        .file-name {
            font-size: 0.9375rem;
            color: #e5e5e5;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 700;
        }

        .file-delete {
            width: 32px;
            height: 32px;
            background: #2a2a2a;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            color: #888888;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            line-height: 1;
            transition: all 0.15s;
        }

        .file-delete:hover {
            background: #9333ea;
            outline-color: #a855f7;
            color: #ffffff;
        }

        /* Quantity Selector */
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            background: #1a1a1a;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            padding: 0.75rem;
            box-shadow: none;
        }

        .quantity-btn {
            width: 2.5rem;
            height: 2.5rem;
            background: #2a2a2a;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            color: #e5e5e5;
            font-size: 1.25rem;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:hover {
            background: #9333ea;
            outline-color: #a855f7;
            transform: none;
        }

        .quantity-btn:focus {
            outline: 2px solid #9333ea;
            outline-offset: 2px;
        }

        .quantity-value {
            flex: 1;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 900;
            color: #e5e5e5;
        }

        /* Button */
        .btn-primary {
            width: 100%;
            padding: 1.5rem 1.5rem;
            background: #9333ea;
            border: none;
            outline: 2px solid #a855f7;
            outline-offset: 0;
            border-radius: 0;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: none;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary:hover {
            background: #a855f7;
            outline-color: #c084fc;
            transform: none;
            box-shadow: none;
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:focus {
            outline: 2px solid rgba(255, 255, 255, 0.5);
            outline-offset: 2px;
        }

        /* Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none !important;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .modal-overlay.show {
            display: flex !important;
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: #1a1a1a;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            padding: 2rem;
            max-width: 420px;
            width: 90%;
            box-shadow: none;
            backdrop-filter: none;
        }

        .modal-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 0.875rem;
            color: #e5e5e5;
            letter-spacing: -0.05em;
            text-transform: uppercase;
        }

        .modal-text {
            font-size: 0.9375rem;
            color: #888888;
            margin-bottom: 2rem;
            line-height: 1.6;
            font-weight: 600;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        .modal-btn.cancel {
            background: #2a2a2a;
            color: #888888;
            outline-color: #3a3a3a;
        }

        .modal-btn.cancel:hover {
            background: #333333;
            outline-color: #4a4a4a;
            color: #e5e5e5;
        }

        .modal-btn.cancel:focus {
            outline: 2px solid rgba(255, 255, 255, 0.5);
            outline-offset: 2px;
        }

        .modal-btn.confirm {
            background: #ffffff;
            color: #000000;
            border: none;
        }

        .modal-btn.confirm:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .modal-btn.confirm:focus {
            outline: 2px solid rgba(255, 255, 255, 0.5);
            outline-offset: 2px;
        }

        .hidden {
            display: none;
        }

        /* Order Preview Modal - Right Side */
        .order-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: flex-end;
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .order-preview-overlay.show {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .order-preview-modal {
            background: #1a1a1a;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            width: 100%;
            max-width: 500px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: none;
            backdrop-filter: none;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow: hidden;
        }

        .order-preview-overlay.show .order-preview-modal {
            transform: translateX(0);
        }

        .order-preview-header {
            padding: 1.5rem;
            border-bottom: 2px solid #3a3a3a;
            background: #1a1a1a;
        }

        .order-preview-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 1.5rem;
            font-weight: 900;
            color: #e5e5e5;
            letter-spacing: -0.05em;
            text-transform: uppercase;
            margin: 0;
        }

        .order-preview-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .order-preview-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .order-preview-section-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 0.875rem;
            font-weight: 900;
            color: #888888;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .order-preview-section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #9333ea;
        }

        .order-preview-image-container {
            background: #0a0a0a;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .order-preview-svg {
            width: 100%;
            max-width: 300px;
            height: auto;
        }

        .order-preview-price-breakdown {
            background: #2a2a2a;
            padding: 1rem;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
        }

        .order-preview-price-line {
            display: flex;
            justify-content: space-between;
            padding: 0.625rem 0;
            font-size: 0.875rem;
            color: #888888;
            font-weight: 600;
        }

        .order-preview-price-line.total {
            border-top: 2px solid #3a3a3a;
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-size: 1.25rem;
            font-weight: 900;
            color: #9333ea;
        }

        .order-preview-price-line .amount {
            font-weight: 800;
            color: #e5e5e5;
        }

        .order-preview-price-line.total .amount {
            color: #9333ea;
            font-size: 1.5rem;
        }

        .order-preview-details {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .order-detail-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #888888;
            font-weight: 600;
        }

        .order-detail-item .label {
            color: #888888;
        }

        .order-detail-item .value {
            color: #e5e5e5;
            font-weight: 800;
        }

        .order-preview-actions {
            padding: 1.5rem;
            border-top: 2px solid #3a3a3a;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .order-preview-btn {
            width: 100%;
            padding: 1.25rem 1.5rem;
            border: none;
            outline: 2px solid;
            outline-offset: 0;
            border-radius: 0;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.15s;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .order-preview-btn.primary {
            background: #9333ea;
            outline-color: #a855f7;
            color: #ffffff;
        }

        .order-preview-btn.primary:hover {
            background: #a855f7;
            outline-color: #c084fc;
        }

        .order-preview-btn.secondary {
            background: transparent;
            outline-color: #3a3a3a;
            color: #888888;
        }

        .order-preview-btn.secondary:hover {
            background: #2a2a2a;
            outline-color: #9333ea;
            color: #e5e5e5;
        }

        .order-preview-btn:focus {
            outline: 2px solid rgba(255, 255, 255, 0.5);
            outline-offset: 2px;
        }

        /* Finish Selector */
        .finish-option {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 1rem;
            background: #1a1a1a;
            border: none;
            outline: 2px solid #3a3a3a;
            outline-offset: 0;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: none;
        }

        .finish-option:hover {
            background: #2a2a2a;
            outline-color: #9333ea;
        }

        .finish-option input[type="radio"]:checked + span {
            color: #2a2a2a;
        }

        .finish-option:has(input[type="radio"]:checked) {
            background: #9333ea;
            outline-color: #a855f7;
        }

        .finish-option:has(input[type="radio"]:checked) span {
            color: #2a2a2a;
        }

        .finish-option:focus-within {
            outline: 2px solid #9333ea;
            outline-offset: 2px;
        }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="header" role="banner">
        <div class="header-container">
            <nav class="nav" role="navigation" aria-label="Main navigation">
                <div class="logo" aria-label="Customizer logo">All in one customizer</div>
                <div class="nav-links" role="list">
                    <a href="#" class="nav-link" role="listitem" aria-label="Navigate to Models">Models</a>
                    <a href="#" class="nav-link" role="listitem" aria-label="Navigate to Services">Services</a>
                    <a href="#" class="nav-link" role="listitem" aria-label="Navigate to Experience">Experience</a>
                    <a href="#" class="nav-link" role="listitem" aria-label="Navigate to Shop">Shop</a>
                    <a href="#" class="nav-link" role="listitem" aria-label="Navigate to Purchase">Purchase</a>
                    <a href="#" class="nav-link active" role="listitem" aria-label="Navigate to Customizer" aria-current="page">Customize</a>
                </div>
            </nav>
            <div class="header-icons">
                <button class="user-account" aria-label="User account menu" aria-haspopup="true">
                    <div class="user-avatar" aria-hidden="true">JD</div>
                    <span class="user-name">John Doe</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Left: 2D Viewer -->
        <div class="viewer-section">
            <!-- Vehicle Dropdown -->
            <div class="vehicle-dropdown">
                <button class="dropdown-trigger" onclick="toggleDropdown()" aria-haspopup="true" aria-expanded="false" aria-label="Select object template">
                    <span id="selected-vehicle">Phone Case</span>
                    <span class="dropdown-icon" aria-hidden="true">â–¼</span>
                </button>
                <div class="dropdown-menu" id="vehicle-menu" role="menu" aria-label="Object selection menu">
                    <div class="vehicle-category">
                        <div class="category-title">2D Objects</div>
                        <div class="vehicle-option active" onclick="selectVehicle('Phone Case', 'phonecase')">
                            <div class="vehicle-icon">ðŸ“±</div>
                            <div class="vehicle-info">
                                <div class="name">Phone Case</div>
                                <div class="type">Customizable Case</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2D SVG Viewer -->
            <div id="canvas-container" style="background: #0a0a0a;">
                <svg id="svg-viewer" viewBox="0 0 320 638" preserveAspectRatio="xMidYMid meet">
                    <!-- SVG content will be loaded here -->
                </svg>
            </div>

        </div>

        <!-- Right: Controls -->
        <div class="control-section">
            <!-- Fixed Pricing -->
            <div class="pricing-fixed">
                <div class="price-display">
                    <div class="price-amount" id="total-price">$20</div>
                    <div class="price-label">total</div>
                </div>
                <button class="price-details-toggle" onclick="togglePriceBreakdown()" aria-expanded="false" aria-controls="price-breakdown" aria-label="Toggle price breakdown">
                    <span id="breakdown-text">Show breakdown</span>
                    <span id="breakdown-arrow" aria-hidden="true">â–¼</span>
                </button>
                <div class="price-breakdown" id="price-breakdown" role="region" aria-label="Price breakdown">
                    <div class="price-line">
                        <span>Base wrap</span>
                        <span class="amount" id="base-price">$20</span>
                    </div>
                    <div class="price-line" id="files-line" style="display: none;">
                        <span>File printing (<span id="file-count">0</span>)</span>
                        <span class="amount" id="files-price">$0</span>
                    </div>
                    <div class="price-line" style="padding-top: 0.75rem; margin-top: 0.5rem; position: relative;">
                    <div class="price-line" style="padding-top: 0.75rem; margin-top: 0.5rem; position: relative;">
                    <style>
                        .price-line[style*="position: relative"]::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            height: 1px;
                            background: #3a3a3a;
                        }
                    </style>
                        <span>Ã— <span id="quantity-display">1</span> item<span id="plural-s"></span></span>
                        <span class="amount"></span>
                    </div>
                </div>
            </div>

            <!-- Scrollable Customization -->
            <div class="customization-panel">
                <!-- CMYK Inputs -->
                <div class="section">
                    <h3 class="section-title">CMYK Values</h3>
                    <div class="cmyk-inputs">
                        <div class="cmyk-input-group">
                            <label class="cmyk-label">Cyan</label>
                            <div class="cmyk-input-wrapper">
                                <input type="number" id="cmyk-c" class="cmyk-input" min="0" max="100" value="0" oninput="updateColorFromCMYK()" aria-label="Cyan percentage">
                                <span class="cmyk-percent" aria-hidden="true">%</span>
                            </div>
                        </div>
                        <div class="cmyk-input-group">
                            <label class="cmyk-label">Magenta</label>
                            <div class="cmyk-input-wrapper">
                                <input type="number" id="cmyk-m" class="cmyk-input" min="0" max="100" value="0" oninput="updateColorFromCMYK()" aria-label="Magenta percentage">
                                <span class="cmyk-percent" aria-hidden="true">%</span>
                            </div>
                        </div>
                        <div class="cmyk-input-group">
                            <label class="cmyk-label">Yellow</label>
                            <div class="cmyk-input-wrapper">
                                <input type="number" id="cmyk-y" class="cmyk-input" min="0" max="100" value="0" oninput="updateColorFromCMYK()" aria-label="Yellow percentage">
                                <span class="cmyk-percent" aria-hidden="true">%</span>
                            </div>
                        </div>
                        <div class="cmyk-input-group">
                            <label class="cmyk-label">Black</label>
                            <div class="cmyk-input-wrapper">
                                <input type="number" id="cmyk-k" class="cmyk-input" min="0" max="100" value="4" oninput="updateColorFromCMYK()" aria-label="Black percentage">
                                <span class="cmyk-percent" aria-hidden="true">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Color -->
                <div class="section">
                    <h3 class="section-title">Wrap Color</h3>
                    
                    <!-- Color Wheel / Picker -->
                    <div class="color-picker-section">
                        <div class="color-picker-wrapper">
                            <input type="color" id="color-picker" class="color-picker-input" value="#f5f5f5" oninput="updateColorFromPicker(this.value)" aria-label="Color picker">
                            <input type="text" id="color-preview" class="color-preview" value="#F5F5F5" placeholder="#FFFFFF" oninput="updateColorFromHex(this.value)" style="background: #f5f5f5;" aria-label="Color hex code">
                        </div>
                    </div>

                    <!-- Subtle Color Swatches -->
                    <div class="color-grid">
                        <!-- Row 1: Basic Colors -->
                        <button type="button" class="color-swatch active" style="background: #f5f5f5; border: none; padding: 0;" onclick="setColor('#f5f5f5', this)" aria-label="Select white color"></button>
                        <button type="button" class="color-swatch" style="background: #2a2a2a; border: none; padding: 0;" onclick="setColor('#2a2a2a', this)" aria-label="Select dark grey color"></button>
                        <button type="button" class="color-swatch" style="background: #c8a882; border: none; padding: 0;" onclick="setColor('#c8a882', this)" aria-label="Select beige color"></button>
                        <button type="button" class="color-swatch" style="background: #9ca3af; border: none; padding: 0;" onclick="setColor('#9ca3af', this)" aria-label="Select grey color"></button>
                        <button type="button" class="color-swatch" style="background: #a78bfa; border: none; padding: 0;" onclick="setColor('#a78bfa', this)" aria-label="Select purple color"></button>
                        <button type="button" class="color-swatch" style="background: #60a5fa; border: none; padding: 0;" onclick="setColor('#60a5fa', this)" aria-label="Select blue color"></button>
                        <!-- Row 2: Vibrant Colors -->
                        <button type="button" class="color-swatch" style="background: #34d399; border: none; padding: 0;" onclick="setColor('#34d399', this)" aria-label="Select green color"></button>
                        <button type="button" class="color-swatch" style="background: #fbbf24; border: none; padding: 0;" onclick="setColor('#fbbf24', this)" aria-label="Select yellow color"></button>
                        <button type="button" class="color-swatch" style="background: #fb7185; border: none; padding: 0;" onclick="setColor('#fb7185', this)" aria-label="Select pink color"></button>
                        <button type="button" class="color-swatch" style="background: #64748b; border: none; padding: 0;" onclick="setColor('#64748b', this)" aria-label="Select slate color"></button>
                        <button type="button" class="color-swatch" style="background: #94a3b8; border: none; padding: 0;" onclick="setColor('#94a3b8', this)" aria-label="Select light slate color"></button>
                        <button type="button" class="color-swatch" style="background: #d1d5db; border: none; padding: 0;" onclick="setColor('#d1d5db', this)" aria-label="Select light grey color"></button>
                        <!-- Row 3: Additional Colors -->
                        <button type="button" class="color-swatch" style="background: #ef4444; border: none; padding: 0;" onclick="setColor('#ef4444', this)" aria-label="Select red color"></button>
                        <button type="button" class="color-swatch" style="background: #f97316; border: none; padding: 0;" onclick="setColor('#f97316', this)" aria-label="Select orange color"></button>
                        <button type="button" class="color-swatch" style="background: #eab308; border: none; padding: 0;" onclick="setColor('#eab308', this)" aria-label="Select amber color"></button>
                        <button type="button" class="color-swatch" style="background: #84cc16; border: none; padding: 0;" onclick="setColor('#84cc16', this)" aria-label="Select lime color"></button>
                        <button type="button" class="color-swatch" style="background: #06b6d4; border: none; padding: 0;" onclick="setColor('#06b6d4', this)" aria-label="Select cyan color"></button>
                        <button type="button" class="color-swatch" style="background: #3b82f6; border: none; padding: 0;" onclick="setColor('#3b82f6', this)" aria-label="Select light blue color"></button>
                        <!-- Row 4: More Colors -->
                        <button type="button" class="color-swatch" style="background: #6366f1; border: none; padding: 0;" onclick="setColor('#6366f1', this)" aria-label="Select indigo color"></button>
                        <button type="button" class="color-swatch" style="background: #8b5cf6; border: none; padding: 0;" onclick="setColor('#8b5cf6', this)" aria-label="Select violet color"></button>
                        <button type="button" class="color-swatch" style="background: #ec4899; border: none; padding: 0;" onclick="setColor('#ec4899', this)" aria-label="Select fuchsia color"></button>
                        <button type="button" class="color-swatch" style="background: #14b8a6; border: none; padding: 0;" onclick="setColor('#14b8a6', this)" aria-label="Select teal color"></button>
                        <button type="button" class="color-swatch" style="background: #0ea5e9; border: none; padding: 0;" onclick="setColor('#0ea5e9', this)" aria-label="Select sky color"></button>
                        <button type="button" class="color-swatch" style="background: #78716c; border: none; padding: 0;" onclick="setColor('#78716c', this)" aria-label="Select stone color"></button>
                        <!-- Row 5: Gradients -->
                        <button type="button" class="color-swatch gradient" style="background: linear-gradient(135deg, #9333ea, #a855f7); border: none; padding: 0;" onclick="setGradient('linear-gradient(135deg, #9333ea, #a855f7)', this)" aria-label="Select purple gradient"></button>
                        <button type="button" class="color-swatch gradient" style="background: linear-gradient(135deg, #3b82f6, #06b6d4); border: none; padding: 0;" onclick="setGradient('linear-gradient(135deg, #3b82f6, #06b6d4)', this)" aria-label="Select blue gradient"></button>
                        <button type="button" class="color-swatch gradient" style="background: linear-gradient(135deg, #fbbf24, #fb7185); border: none; padding: 0;" onclick="setGradient('linear-gradient(135deg, #fbbf24, #fb7185)', this)" aria-label="Select sunset gradient"></button>
                        <button type="button" class="color-swatch gradient" style="background: linear-gradient(135deg, #34d399, #06b6d4); border: none; padding: 0;" onclick="setGradient('linear-gradient(135deg, #34d399, #06b6d4)', this)" aria-label="Select ocean gradient"></button>
                        <button type="button" class="color-swatch gradient" style="background: linear-gradient(135deg, #ec4899, #8b5cf6); border: none; padding: 0;" onclick="setGradient('linear-gradient(135deg, #ec4899, #8b5cf6)', this)" aria-label="Select pink purple gradient"></button>
                        <button type="button" class="color-swatch gradient" style="background: linear-gradient(135deg, #f97316, #eab308); border: none; padding: 0;" onclick="setGradient('linear-gradient(135deg, #f97316, #eab308)', this)" aria-label="Select fire gradient"></button>
                    </div>

                    <!-- Gradient Customizer -->
                    <div class="gradient-section">
                        <div class="gradient-label">Custom Gradient</div>
                        <div class="gradient-picker">
                            <input type="color" id="gradient-start" class="gradient-color-input" value="#9333ea" oninput="updateGradient()" aria-label="Gradient start color">
                            <input type="color" id="gradient-end" class="gradient-color-input" value="#a855f7" oninput="updateGradient()" aria-label="Gradient end color">
                        </div>
                        <div id="gradient-preview" class="gradient-preview" style="background: linear-gradient(135deg, #9333ea, #a855f7);" onclick="applyCustomGradient()" aria-label="Apply custom gradient"></div>
                    </div>

                    <!-- Finish Selector -->
                    <div class="color-picker-section">
                        <h4 style="font-size: 0.75rem; font-weight: 600; color: rgba(255, 255, 255, 0.6); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Finish</h4>
                        <div style="display: flex; gap: 0.75rem;">
                            <label class="finish-option">
                                <input type="radio" name="finish" value="matt" id="finish-matt" checked onchange="updateFinish('matt')" style="cursor: pointer; accent-color: #9333ea;" aria-label="Matt finish">
                                <span style="font-size: 0.875rem; font-weight: 500;">Matt</span>
                            </label>
                            <label class="finish-option">
                                <input type="radio" name="finish" value="glossy" id="finish-glossy" onchange="updateFinish('glossy')" style="cursor: pointer; accent-color: #9333ea;" aria-label="Glossy finish">
                                <span style="font-size: 0.875rem; font-weight: 500;">Glossy</span>
                            </label>
                        </div>
                    </div>

                </div>

                <!-- Patterns -->
                <div class="section preset-section">
                    <h3 class="section-title">Patterns</h3>
                    <div class="preset-grid">
                        <button type="button" class="preset-item" onclick="addPresetLogo('zebra')">
                            <div class="preset-icon" aria-hidden="true">
                                <i data-lucide="scan-line"></i>
                            </div>
                            <div>
                                <div class="preset-label">Zebra</div>
                                <div class="preset-subtext">High-contrast organic stripes</div>
                            </div>
                        </button>
                        <button type="button" class="preset-item" onclick="addPresetLogo('stripes')">
                            <div class="preset-icon" aria-hidden="true">
                                <i data-lucide="slash"></i>
                            </div>
                            <div>
                                <div class="preset-label">Stripes</div>
                                <div class="preset-subtext">Clean angled lines</div>
                            </div>
                        </button>
                        <button type="button" class="preset-item" onclick="addPresetLogo('dots')">
                            <div class="preset-icon" aria-hidden="true">
                                <i data-lucide="grip-horizontal"></i>
                            </div>
                            <div>
                                <div class="preset-label">Dots</div>
                                <div class="preset-subtext">Soft halftone texture</div>
                            </div>
                        </button>
                        <button type="button" class="preset-item" onclick="addPresetLogo('squares')">
                            <div class="preset-icon" aria-hidden="true">
                                <i data-lucide="layout-dashboard"></i>
                            </div>
                            <div>
                                <div class="preset-label">Squares</div>
                                <div class="preset-subtext">Modern grid blocks</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- File Upload -->
                <div class="section">
                    <h3 class="section-title">Upload Files (Max 5)</h3>
                    <button type="button" class="file-upload-section" onclick="document.getElementById('file-input').click()" style="width: 100%; background: transparent; cursor: pointer;" aria-label="Upload files">
                        <div class="upload-icon" aria-hidden="true">ðŸ“</div>
                        <div class="upload-text">Click to upload files</div>
                        <div class="upload-subtext">PNG, JPG, PDF up to 10MB each</div>
                    </button>
                    <input type="file" id="file-input" accept="image/*" multiple style="display: none;" onchange="handleFileUpload(event)">
                    <div class="files-list" id="files-list"></div>
                </div>

                <!-- Quantity -->
                <div class="section">
                    <h3 class="section-title">Amount</h3>
                    <div class="quantity-selector">
                        <button class="quantity-btn" onclick="decrementQuantity()" aria-label="Decrease quantity">âˆ’</button>
                        <div class="quantity-value" id="quantity" aria-live="polite" aria-atomic="true">1</div>
                        <button class="quantity-btn" onclick="incrementQuantity()" aria-label="Increase quantity">+</button>
                    </div>
                </div>
            </div>

            <!-- Fixed Order Button -->
            <div class="order-button-container">
                <button class="btn-primary" onclick="openOrderPreview()">Order now</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal">
            <h3 class="modal-title">Delete File?</h3>
            <p class="modal-text">Are you sure you want to remove this file? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="cancelDelete()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Order Preview Modal -->
    <div class="order-preview-overlay" id="order-preview-overlay" onclick="if(event.target === this) closeOrderPreview()">
        <div class="order-preview-modal">
            <div class="order-preview-header">
                <h2 class="order-preview-title">Order Preview</h2>
            </div>
            <div class="order-preview-content">
                <!-- Preview Image -->
                <div class="order-preview-section">
                    <h3 class="order-preview-section-title">Preview</h3>
                    <div class="order-preview-image-container">
                        <svg id="order-preview-svg" class="order-preview-svg" viewBox="0 0 320 638" preserveAspectRatio="xMidYMid meet">
                            <!-- SVG preview will be cloned here -->
                        </svg>
                    </div>
                </div>

                <!-- Order Details -->
                <div class="order-preview-section">
                    <h3 class="order-preview-section-title">Order Details</h3>
                    <div class="order-preview-details">
                        <div class="order-detail-item">
                            <span class="label">Product:</span>
                            <span class="value" id="order-preview-product">Phone Case</span>
                        </div>
                        <div class="order-detail-item">
                            <span class="label">Quantity:</span>
                            <span class="value" id="order-preview-quantity">1</span>
                        </div>
                        <div class="order-detail-item">
                            <span class="label">Finish:</span>
                            <span class="value" id="order-preview-finish">Matt</span>
                        </div>
                        <div class="order-detail-item" id="order-preview-files-item" style="display: none;">
                            <span class="label">Files:</span>
                            <span class="value" id="order-preview-files-count">0</span>
                        </div>
                    </div>
                </div>

                <!-- Price Breakdown -->
                <div class="order-preview-section">
                    <h3 class="order-preview-section-title">Price Breakdown</h3>
                    <div class="order-preview-price-breakdown">
                        <div class="order-preview-price-line">
                            <span>Base wrap</span>
                            <span class="amount" id="order-preview-base-price">$20</span>
                        </div>
                        <div class="order-preview-price-line" id="order-preview-files-line" style="display: none;">
                            <span>File printing (<span id="order-preview-file-count">0</span>)</span>
                            <span class="amount" id="order-preview-files-price">$0</span>
                        </div>
                        <div class="order-preview-price-line total">
                            <span>Total</span>
                            <span class="amount" id="order-preview-total-price">$20</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="order-preview-actions">
                <button class="order-preview-btn primary" onclick="proceedToCheckout()">Next</button>
                <button class="order-preview-btn secondary" onclick="closeOrderPreview()">Edit</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let state = {
            vehicleType: 'phonecase',
            vehicleName: 'Phone Case',
            color: '#f5f5f5',
            isGradient: false,
            files: [],
            quantity: 1,
            finish: 'matt'
        };

        let fileToDelete = null;

        // SVG object templates
        const svgTemplates = {
            'Phone Case': 'phonecase.svg'
        };

        // SVG manipulation variables
        let svgViewer = null; // The main SVG element
        let svgContent = null; // The loaded SVG content
        let uploadedImages = []; // Store uploaded images for SVG
        let isPositioning = false; // Whether user is in positioning mode
        let positioningImageId = null; // ID of image being positioned
        let isDraggingImage = false; // Whether user is currently dragging to position image
        let patternColor = '#ffffff'; // Global tint for pattern overlays
        let currentImageElements = []; // Store SVG image elements

        // Simple SVG pattern presets that can be dropped onto the 2D object as overlays
        const logoPresets = {
            zebra: {
                name: 'Zebra pattern',
                svg: `
                    <svg xmlns="http://www.w3.org/2000/svg" width="600" height="400" viewBox="0 0 600 400">
                        <defs>
                            <pattern id="zebraStripes" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                                <rect width="40" height="40" fill="#0b1120"/>
                                <path d="M-10 10 L10 -10 M0 40 L40 0 M30 50 L50 30" stroke="#f9fafb" stroke-width="10" stroke-linecap="round"/>
                            </pattern>
                        </defs>
                        <rect width="600" height="400" fill="#020617"/>
                        <rect x="40" y="40" width="520" height="320" rx="40" fill="url(#zebraStripes)"/>
                    </svg>
                `
            },
            stripes: {
                name: 'Stripes pattern',
                svg: `
                    <svg xmlns="http://www.w3.org/2000/svg" width="600" height="400" viewBox="0 0 600 400">
                        <defs>
                            <linearGradient id="stripesBg" x1="0" y1="0" x2="1" y2="0">
                                <stop offset="0" stop-color="#0b1120"/>
                                <stop offset="1" stop-color="#020617"/>
                            </linearGradient>
                        </defs>
                        <rect width="600" height="400" fill="url(#stripesBg)"/>
                        <g fill="#e5e7eb" opacity="0.9">
                            <rect x="-40" y="40" width="120" height="20" transform="rotate(-20 20 50)"/>
                            <rect x="40" y="120" width="220" height="22" transform="rotate(-20 150 130)"/>
                            <rect x="180" y="200" width="260" height="24" transform="rotate(-20 310 212)"/>
                            <rect x="320" y="280" width="220" height="20" transform="rotate(-20 430 290)"/>
                        </g>
                    </svg>
                `
            },
            dots: {
                name: 'Dots pattern',
                svg: `
                    <svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">
                        <defs>
                            <radialGradient id="dotsBg" cx="0.3" cy="0.2" r="0.9">
                                <stop offset="0" stop-color="#020617"/>
                                <stop offset="1" stop-color="#020617"/>
                            </radialGradient>
                            <pattern id="dotsPattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                                <circle cx="4" cy="4" r="3" fill="#f9fafb" opacity="0.9"/>
                            </pattern>
                        </defs>
                        <rect width="500" height="500" fill="url(#dotsBg)"/>
                        <circle cx="250" cy="250" r="210" fill="url(#dotsPattern)"/>
                    </svg>
                `
            },
            squares: {
                name: 'Squares pattern',
                svg: `
                    <svg xmlns="http://www.w3.org/2000/svg" width="600" height="400" viewBox="0 0 600 400">
                        <rect width="600" height="400" fill="#020617"/>
                        <g transform="translate(60,60)">
                            <rect x="0" y="0" width="140" height="120" rx="12" fill="#f97316" opacity="0.95"/>
                            <rect x="160" y="40" width="140" height="120" rx="12" fill="#e5e7eb" opacity="0.95"/>
                            <rect x="320" y="0" width="140" height="120" rx="12" fill="#0b1120" opacity="0.95"/>
                            <rect x="40" y="160" width="140" height="120" rx="12" fill="#22c55e" opacity="0.95"/>
                            <rect x="200" y="200" width="180" height="120" rx="16" fill="#38bdf8" opacity="0.95"/>
                        </g>
                    </svg>
                `
            }
        };

        let logoPresetCounter = 0;

        function initSVGViewer() {
            svgViewer = document.getElementById('svg-viewer');
            if (!svgViewer) return;

            // Load the default SVG template
            loadSVGTemplate('phonecase.svg');

            // Mouse interaction for image positioning
            svgViewer.addEventListener('mousedown', (e) => {
                if (isPositioning && positioningImageId !== null) {
                    isDraggingImage = true;
                    e.preventDefault();
                    e.stopPropagation();
                    handleImagePositioning(e);
                }
            });

            svgViewer.addEventListener('mousemove', (e) => {
                if (isDraggingImage && isPositioning && positioningImageId !== null) {
                    e.preventDefault();
                    handleImagePositioning(e);
                }
            });

            svgViewer.addEventListener('mouseup', (e) => {
                if (isDraggingImage) {
                    isDraggingImage = false;
                }
            });

            svgViewer.addEventListener('mouseleave', (e) => {
                isDraggingImage = false;
            });
        }

        function loadSVGTemplate(filename) {
            // Check if we're running from file:// protocol
            if (window.location.protocol === 'file:') {
                console.error('Please access this page via http://localhost:8000 instead of file://');
                alert('âš ï¸ CORS Error: Please access this page via http://localhost:8000\n\nThe file:// protocol blocks loading SVG files. Use the local server instead.');
                // Create a simple fallback SVG
                svgViewer.innerHTML = '<rect width="320" height="638" fill="#F5F5F5" rx="20"/><text x="160" y="319" text-anchor="middle" fill="#666" font-size="16">Please use http://localhost:8000</text>';
                svgViewer.setAttribute('viewBox', '0 0 320 638');
                svgContent = svgViewer;
                return;
            }

            fetch(filename)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(svgText => {
                    // Parse the SVG
                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                    const importedSvg = svgDoc.documentElement;

                    // Check for parsing errors
                    const parserError = svgDoc.querySelector('parsererror');
                    if (parserError) {
                        throw new Error('SVG parsing error: ' + parserError.textContent);
                    }

                    // Clear existing content
                    svgViewer.innerHTML = '';

                    // Copy all elements from the imported SVG
                    Array.from(importedSvg.children).forEach(child => {
                        svgViewer.appendChild(child.cloneNode(true));
                    });

                    // Copy attributes
                    if (importedSvg.hasAttribute('viewBox')) {
                        svgViewer.setAttribute('viewBox', importedSvg.getAttribute('viewBox'));
                    }

                    svgContent = svgViewer;
                    updateSVGColor();
                    applyImagesToSVG();
                })
                .catch(error => {
                    console.error('Error loading SVG:', error);
                    // Create a simple fallback SVG
                    svgViewer.innerHTML = '<rect width="320" height="638" fill="#F5F5F5" rx="20"/><text x="160" y="319" text-anchor="middle" fill="#666" font-size="14">Error loading SVG. Check console.</text>';
                    svgViewer.setAttribute('viewBox', '0 0 320 638');
                    svgContent = svgViewer;
                });
        }

        // Old Three.js functions removed - no longer needed for 2D SVG customizer
        /*
        function loadVehicleModel_OLD(modelFile = null) {
            // Check if GLTFLoader is available
            if (typeof THREE.GLTFLoader === 'undefined') {
                console.error('GLTFLoader is not available. Using fallback geometry.');
                createFallbackCar();
                return;
            }
            
            // Determine which model file to load
            const modelFilename = modelFile || vehicleModels[state.vehicleName] || 'Cadillac CT4 V 2022.glb';
            
            // Load GLB model
            const loader = new THREE.GLTFLoader();
            loader.load(modelFilename, 
                    (gltf) => {
                        if (car) {
                            // Remove old decals
                            decals.forEach(decal => scene.remove(decal));
                            decals = [];
                            scene.remove(car);
                        }
                        car = gltf.scene;
                        
                        // Calculate bounding box to center and scale model
                        const box = new THREE.Box3().setFromObject(car);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());
                        
                        // Scale to fit nicely in view
                        const maxDim = Math.max(size.x, size.y, size.z);
                        const scale = 2.5 / maxDim;
                        baseScale = scale; // Store the base scale
                        car.scale.set(scale, scale, scale);
                        
                        // Center the model at origin after scaling
                        // First get the new bounding box after scaling
                        const scaledBox = new THREE.Box3().setFromObject(car);
                        const scaledCenter = scaledBox.getCenter(new THREE.Vector3());
                        
                        // Move model to center it at origin
                        car.position.x = -scaledCenter.x;
                        car.position.y = -scaledCenter.y + 0.5; // Slight lift above ground
                        car.position.z = -scaledCenter.z;
                        
                        car.rotation.y = Math.PI / 4; // Slight angle for better view
                        
                        // Store reference to car body meshes for decals
                        car.userData.bodyMeshes = [];
                        // Store materials that should be colored
                        car.userData.colorableMaterials = [];
                        
                        // Apply color and enable shadows
                        car.traverse((child) => {
                            if (child.isMesh) {
                                child.castShadow = true;
                                child.receiveShadow = true;
                                
                                // Store body meshes (for decal application)
                                if (child.material) {
                                    // Handle both single materials and material arrays
                                    const materials = Array.isArray(child.material) ? child.material : [child.material];
                                    
                                    materials.forEach((material, index) => {
                                        if (material) {
                                            // Store original material properties
                                            if (!child.userData.originalColor) {
                                                child.userData.originalColor = material.color ? material.color.clone() : null;
                                            }
                                            if (child.userData.originalMetalness === undefined) {
                                                child.userData.originalMetalness = material.metalness;
                                                child.userData.originalRoughness = material.roughness;
                                            }
                                            
                                            // Apply wrap color to main body parts (not glass/chrome)
                                            // Skip transparent materials (glass, windows)
                                            if (!material.transparent) {
                                                // Skip highly metallic materials (chrome, mirrors) - same threshold as updateCarColor
                                                const isChrome = material.metalness !== undefined && material.metalness >= 0.95;
                                                
                                                // Color all non-chrome, non-transparent materials
                                                if (!isChrome) {
                                                    const colorObj = new THREE.Color(state.color);
                                                    material.color.copy(colorObj);
                                                    material.needsUpdate = true;
                                                    
                                                    // Store this material reference for direct updates
                                                    car.userData.colorableMaterials.push(material);
                                                    
                                                    // Mark this mesh as colorable for future updates
                                                    child.userData.isColorable = true;
                                                    
                                                    // Store body meshes for decal placement (only once)
                                                    if (!car.userData.bodyMeshes.includes(child)) {
                                                        car.userData.bodyMeshes.push(child);
                                                    }
                                                }
                                            }
                                        }
                                    });
                                }
                            }
                        });
                        
                        scene.add(car);
                        addGround();
                        
                        // Ensure white color is applied to all materials
                        updateCarColor();
                        
                        // Apply existing customizations
                        applyImagesToModel();
                    },
                    (progress) => {
                        console.log('Loading: ' + (progress.loaded / progress.total * 100) + '%');
                    },
                    (error) => {
                        console.error('GLB loading failed:', error);
                        console.log('Using fallback geometry');
                        createFallbackCar();
                    }
                );
        }

        // Removed createFallbackCar - replaced with SVG loading
        function createFallbackCar_OLD() {
            if (car) {
                // Remove old decals
                decals.forEach(decal => scene.remove(decal));
                decals = [];
                scene.remove(car);
            }
            
            car = new THREE.Group();
            car.userData.bodyMeshes = [];
            const color = new THREE.Color(state.color);

            createSedan(car, color);

            // Center the fallback car and set rotation
            const box = new THREE.Box3().setFromObject(car);
            const center = box.getCenter(new THREE.Vector3());
            car.position.x = -center.x;
            car.position.y = -center.y + 0.5; // Slight lift above ground
            car.position.z = -center.z;
            car.rotation.y = Math.PI / 4; // Slight angle for better view
            
            // Fallback car uses default scale of 1.0
            baseScale = 1.0;

            scene.add(car);
            // Ensure white color is applied to all materials
            updateCarColor();
            
            // Apply existing customizations
            applyImagesToModel();
        }

        function createSedan(group, color) {
            const bodyMaterial = new THREE.MeshStandardMaterial({ 
                color: color,
                metalness: 0.5,
                roughness: 0.4
            });

            const body = new THREE.Mesh(
                new THREE.BoxGeometry(4, 1.2, 1.8),
                bodyMaterial
            );
            body.position.y = 0.6;
            body.castShadow = true;
            body.receiveShadow = true;
            body.userData.isColorable = true;
            group.add(body);
            group.mainBody = body;
            if (group.userData && group.userData.bodyMeshes) {
                group.userData.bodyMeshes.push(body);
            }

            const roof = new THREE.Mesh(
                new THREE.BoxGeometry(2, 0.9, 1.6),
                bodyMaterial
            );
            roof.position.y = 1.45;
            roof.castShadow = true;
            roof.userData.isColorable = true;
            group.add(roof);

            addWheels(group, 0.35, 2.8);
            addGround();
        }

        function addWheels(group, radius, spacing) {
            const wheelMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x1a1a1a,
                metalness: 0.6,
                roughness: 0.4
            });

            const positions = [
                [spacing/2, radius - 0.4, 1.2],
                [spacing/2, radius - 0.4, -1.2],
                [-spacing/2, radius - 0.4, 1.2],
                [-spacing/2, radius - 0.4, -1.2]
            ];

            positions.forEach(pos => {
                const wheel = new THREE.Mesh(
                    new THREE.CylinderGeometry(radius, radius, 0.35, 24),
                    wheelMaterial
                );
                wheel.position.set(pos[0], pos[1], pos[2]);
                wheel.rotation.z = Math.PI / 2;
                wheel.castShadow = true;
                group.add(wheel);
            });
        }

        function addGround() {
            if (scene.getObjectByName('ground')) return;
            
            const ground = new THREE.Mesh(
                new THREE.CircleGeometry(25, 64),
                new THREE.MeshStandardMaterial({ 
                    color: 0x000000,
                    metalness: 0.1,
                    roughness: 0.9
                })
            );
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.4;
            ground.receiveShadow = true;
            ground.name = 'ground';
            scene.add(ground);

            const shadowPlane = new THREE.Mesh(
                new THREE.PlaneGeometry(40, 40),
                new THREE.ShadowMaterial({ opacity: 0.3 })
            );
            shadowPlane.rotation.x = -Math.PI / 2;
            shadowPlane.position.y = -0.39;
            shadowPlane.receiveShadow = true;
            scene.add(shadowPlane);
        }
        */

        function updateCarColor() {
            updateSVGColor();
        }

        function updateSVGColor() {
            if (!svgContent) return;

            // Handle gradients
            if (state.isGradient && state.color && state.color.includes('gradient')) {
                // Create or get gradient definition
                let defs = svgContent.querySelector('defs');
                if (!defs) {
                    defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                    svgContent.insertBefore(defs, svgContent.firstChild);
                }

                // Remove existing gradient if any
                const existingGradient = defs.querySelector('#custom-gradient');
                if (existingGradient) {
                    existingGradient.remove();
                }

                // Parse gradient
                const gradientMatch = state.color.match(/linear-gradient\((\d+)deg,\s*#([0-9a-fA-F]{6}),\s*#([0-9a-fA-F]{6})\)/);
                if (gradientMatch) {
                    const angle = parseInt(gradientMatch[1]);
                    const startColor = '#' + gradientMatch[2];
                    const endColor = '#' + gradientMatch[3];

                    // Create SVG gradient
                    const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                    gradient.setAttribute('id', 'custom-gradient');
                    gradient.setAttribute('x1', '0%');
                    gradient.setAttribute('y1', '0%');
                    gradient.setAttribute('x2', '100%');
                    gradient.setAttribute('y2', '100%');
                    
                    // Adjust gradient direction based on angle
                    if (angle === 135) {
                        gradient.setAttribute('x1', '0%');
                        gradient.setAttribute('y1', '0%');
                        gradient.setAttribute('x2', '100%');
                        gradient.setAttribute('y2', '100%');
                    } else if (angle === 45) {
                        gradient.setAttribute('x1', '0%');
                        gradient.setAttribute('y1', '100%');
                        gradient.setAttribute('x2', '100%');
                        gradient.setAttribute('y2', '0%');
                    } else if (angle === 90) {
                        gradient.setAttribute('x1', '0%');
                        gradient.setAttribute('y1', '0%');
                        gradient.setAttribute('x2', '0%');
                        gradient.setAttribute('y2', '100%');
                    } else if (angle === 0) {
                        gradient.setAttribute('x1', '0%');
                        gradient.setAttribute('y1', '0%');
                        gradient.setAttribute('x2', '100%');
                        gradient.setAttribute('y2', '0%');
                    }

                    const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                    stop1.setAttribute('offset', '0%');
                    stop1.setAttribute('stop-color', startColor);
                    gradient.appendChild(stop1);

                    const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                    stop2.setAttribute('offset', '100%');
                    stop2.setAttribute('stop-color', endColor);
                    gradient.appendChild(stop2);

                    defs.appendChild(gradient);

                    // Apply gradient to fillable elements
                    const fillableElements = svgContent.querySelectorAll('[fill], path, rect, circle, ellipse, polygon, polyline');
                    fillableElements.forEach(element => {
                        const fill = element.getAttribute('fill');
                        if (fill && fill !== 'none' && fill !== 'transparent' && !fill.startsWith('url(')) {
                            element.setAttribute('fill', 'url(#custom-gradient)');
                        }
                    });
                }
            } else {
                // Regular solid color
                const fillableElements = svgContent.querySelectorAll('[fill], path, rect, circle, ellipse, polygon, polyline');
                fillableElements.forEach(element => {
                    const fill = element.getAttribute('fill');
                    // Only update elements that have a fill color (not 'none' or transparent)
                    if (fill && fill !== 'none' && fill !== 'transparent' && !fill.startsWith('url(')) {
                        // Check if this is a main body element (not a pattern or gradient)
                        if (!fill.startsWith('url(')) {
                            element.setAttribute('fill', state.color);
                        }
                    }
                });
            }

            // Also update stroke colors if they exist
            const strokeElements = svgContent.querySelectorAll('[stroke]');
            strokeElements.forEach(element => {
                const stroke = element.getAttribute('stroke');
                if (stroke && stroke !== 'none' && stroke !== 'transparent' && !stroke.startsWith('url(')) {
                    // Optionally update stroke colors too
                    // element.setAttribute('stroke', state.color);
                }
            });
        }

        // Create text texture from canvas

        // Handle image positioning on SVG
        function handleImagePositioning(event) {
            if (!svgViewer || !isPositioning || positioningImageId === null) {
                return;
            }
            
            const rect = svgViewer.getBoundingClientRect();
            const svgPoint = svgViewer.createSVGPoint();
            svgPoint.x = event.clientX - rect.left;
            svgPoint.y = event.clientY - rect.top;
            
            // Convert to SVG coordinates
            const ctm = svgViewer.getScreenCTM();
            if (ctm) {
                svgPoint.x = (svgPoint.x - ctm.e) / ctm.a;
                svgPoint.y = (svgPoint.y - ctm.f) / ctm.d;
            }
            
            // Find the image data and update its position
            const imageData = uploadedImages.find(img => String(img.id) === String(positioningImageId));
            if (imageData) {
                imageData.x = svgPoint.x - (imageData.width || 100) / 2;
                imageData.y = svgPoint.y - (imageData.height || 100) / 2;
                applyImagesToSVG();
            }
        }

        // Start positioning mode for an image
        function startImagePositioning(imageId) {
            if (!svgViewer) {
                alert('Please wait for the SVG to load before positioning images.');
                return;
            }
            
            const imageIdStr = String(imageId);
            isPositioning = true;
            positioningImageId = imageIdStr;
            
            // Highlight the selected image
            applyImagesToSVG();
            
            // Update UI to show positioning mode
            renderFilesList();
            
            // Show instruction
            showPositioningHint(true);
            
            // Add a visual indicator
            const container = document.getElementById('canvas-container');
            if (container) {
                container.style.cursor = 'crosshair';
            }
        }

        // Stop positioning mode
        function stopImagePositioning() {
            isPositioning = false;
            positioningImageId = null;
            isDraggingImage = false;
            
            // Reset cursor
            const container = document.getElementById('canvas-container');
            if (container) {
                container.style.cursor = '';
            }
            
            // Update UI
            renderFilesList();
            
            // Reapply images to remove positioning highlight
            applyImagesToSVG();
            
            // Hide instruction
            showPositioningHint(false);
        }
        
        // Make functions globally accessible
        window.startImagePositioning = startImagePositioning;
        window.stopImagePositioning = stopImagePositioning;

        // Show/hide positioning hint
        function showPositioningHint(show) {
            let hint = document.getElementById('positioning-hint');
            if (show && !hint) {
                hint = document.createElement('div');
                hint.id = 'positioning-hint';
                hint.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(10, 10, 15, 0.95);
                    backdrop-filter: blur(20px);
                    border: none;
                    outline: 2px solid #9333ea;
                    outline-offset: 0;
                    border-radius: 0;
                    padding: 1.5rem 2rem;
                    z-index: 1000;
                    pointer-events: none;
                    font-size: 1rem;
                    color: #ffffff;
                    text-align: center;
                `;
                hint.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸŽ¯</div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Positioning Image</div>
                    <div style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.6);">Click and drag on the object to position the image</div>
                    <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.5); margin-top: 0.5rem;">Press ESC to cancel</div>
                `;
                document.getElementById('canvas-container').appendChild(hint);
            } else if (!show && hint) {
                hint.remove();
            }
        }

        // Apply uploaded images to SVG
        function applyImagesToSVG() {
            if (!svgViewer || uploadedImages.length === 0) {
                // Remove existing image elements
                currentImageElements.forEach(imgEl => imgEl.remove());
                currentImageElements = [];
                return;
            }

            // Remove existing image elements
            currentImageElements.forEach(imgEl => imgEl.remove());
            currentImageElements = [];

            // Get SVG viewBox dimensions for default positioning
            const viewBox = svgViewer.getAttribute('viewBox');
            let svgWidth = 320, svgHeight = 638;
            if (viewBox) {
                const parts = viewBox.split(' ');
                if (parts.length >= 4) {
                    const parsedWidth = parseFloat(parts[2]);
                    const parsedHeight = parseFloat(parts[3]);
                    // Validate that parseFloat returned actual numbers before using them
                    if (!isNaN(parsedWidth) && isFinite(parsedWidth)) {
                        svgWidth = parsedWidth;
                    }
                    if (!isNaN(parsedHeight) && isFinite(parsedHeight)) {
                        svgHeight = parsedHeight;
                    }
                }
            }

            // Ensure defs element exists
            let defs = svgViewer.querySelector('defs');
            if (!defs) {
                defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                svgViewer.insertBefore(defs, svgViewer.firstChild);
            }

            // Apply each uploaded image
            uploadedImages.forEach((imageData, index) => {
                // Set dimensions - for patterns, scale to fit within SVG bounds
                let width = imageData.width || 100;
                let height = imageData.height || 100;
                
                // If pattern is larger than SVG, scale it down to fit
                if (imageData.isPattern) {
                    const maxWidth = svgWidth * 0.9; // 90% of SVG width
                    const maxHeight = svgHeight * 0.9; // 90% of SVG height
                    if (width > maxWidth || height > maxHeight) {
                        const scaleX = maxWidth / width;
                        const scaleY = maxHeight / height;
                        const scale = Math.min(scaleX, scaleY);
                        width = width * scale;
                        height = height * scale;
                        // Update stored dimensions
                        imageData.width = width;
                        imageData.height = height;
                    }
                }
                
                // Set position
                let x = imageData.x !== undefined ? imageData.x : (svgWidth / 2 - width / 2);
                let y = imageData.y !== undefined ? imageData.y : (svgHeight / 2 - height / 2 + (index * 120));
                
                // Set opacity
                const baseOpacity = imageData.opacity !== undefined ? imageData.opacity : 0.95;
                const opacity = String(imageData.id) === String(positioningImageId)
                    ? Math.min(0.7, baseOpacity)
                    : baseOpacity;

                // Handle SVG patterns differently - embed directly
                if (imageData.isPattern && imageData.svgContent) {
                    // Parse the SVG pattern
                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(imageData.svgContent, 'image/svg+xml');
                    const sourceSvg = svgDoc.documentElement;
                    
                    // Create a group to contain the pattern
                    const patternGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    patternGroup.setAttribute('data-image-id', imageData.id);
                    patternGroup.setAttribute('opacity', opacity);
                    
                    // Calculate scale factors and store them for repositioning
                    // Use stored values if available (for repositioning), otherwise calculate
                    let scaleX, scaleY, vbX = 0, vbY = 0, vbWidth, vbHeight;
                    const patternViewBox = sourceSvg.getAttribute('viewBox');
                    
                    if (imageData.patternScaleX && imageData.patternScaleY) {
                        // Use stored scale values (for repositioning)
                        scaleX = imageData.patternScaleX;
                        scaleY = imageData.patternScaleY;
                        vbX = imageData.patternVbX || 0;
                        vbY = imageData.patternVbY || 0;
                    } else {
                        // Calculate scale for first time
                        if (patternViewBox) {
                            const parts = patternViewBox.split(' ');
                            if (parts.length >= 4) {
                                vbX = parseFloat(parts[0]) || 0;
                                vbY = parseFloat(parts[1]) || 0;
                                const parsedWidth = parseFloat(parts[2]);
                                const parsedHeight = parseFloat(parts[3]);
                                // Validate that parseFloat returned actual numbers before using them
                                if (!isNaN(parsedWidth) && !isNaN(parsedHeight) && isFinite(parsedWidth) && isFinite(parsedHeight) && parsedWidth > 0 && parsedHeight > 0) {
                                    vbWidth = parsedWidth;
                                    vbHeight = parsedHeight;
                                    scaleX = width / vbWidth;
                                    scaleY = height / vbHeight;
                                } else {
                                    scaleX = 1;
                                    scaleY = 1;
                                }
                            } else {
                                scaleX = 1;
                                scaleY = 1;
                            }
                        } else {
                            // Use width/height from source SVG
                            const sourceWidth = parseFloat(sourceSvg.getAttribute('width')) || width;
                            const sourceHeight = parseFloat(sourceSvg.getAttribute('height')) || height;
                            scaleX = width / sourceWidth;
                            scaleY = height / sourceHeight;
                        }
                        
                        // Store scale info for repositioning
                        imageData.patternScaleX = scaleX;
                        imageData.patternScaleY = scaleY;
                        imageData.patternVbX = vbX;
                        imageData.patternVbY = vbY;
                    }
                    
                    // Build transform string
                    let transformStr = `translate(${x}, ${y})`;
                    if (patternViewBox && (vbX !== 0 || vbY !== 0)) {
                        transformStr += ` scale(${scaleX}, ${scaleY}) translate(${-vbX}, ${-vbY})`;
                    } else {
                        transformStr += ` scale(${scaleX}, ${scaleY})`;
                    }
                    patternGroup.setAttribute('transform', transformStr);
                    
                    // Namespace all IDs in the pattern to avoid conflicts
                    const uniqueIdPrefix = `pattern-${imageData.id}-`;
                    const allElements = sourceSvg.querySelectorAll('*');
                    const idMap = new Map(); // Map old IDs to new IDs
                    
                    // First pass: collect all IDs and create mapping
                    allElements.forEach(el => {
                        if (el.id) {
                            const oldId = el.id;
                            const newId = uniqueIdPrefix + oldId;
                            idMap.set(oldId, newId);
                            el.id = newId;
                        }
                    });
                    
                    // Second pass: update all references to old IDs
                    allElements.forEach(el => {
                        // Check href and xlink:href attributes
                        const href = el.getAttribute('href');
                        const xlinkHref = el.getAttributeNS('http://www.w3.org/1999/xlink', 'href');
                        if (href && href.startsWith('#')) {
                            const id = href.substring(1);
                            if (idMap.has(id)) {
                                el.setAttributeNS('http://www.w3.org/1999/xlink', 'href', `#${idMap.get(id)}`);
                            }
                        }
                        if (xlinkHref && xlinkHref.startsWith('#')) {
                            const id = xlinkHref.substring(1);
                            if (idMap.has(id)) {
                                el.setAttributeNS('http://www.w3.org/1999/xlink', 'href', `#${idMap.get(id)}`);
                            }
                        }
                        
                        // Check fill, stroke, mask, and filter attributes (which use url(#id))
                        ['fill', 'stroke', 'mask', 'filter'].forEach(attr => {
                            const val = el.getAttribute(attr);
                            if (val && val.startsWith('url(#')) {
                                const match = val.match(/^url\(#([^)]+)\)$/);
                                if (match) {
                                    const id = match[1];
                                    if (idMap.has(id)) {
                                        el.setAttribute(attr, `url(#${idMap.get(id)})`);
                                    }
                                }
                            }
                        });
                    });
                    
                    // Copy defs from pattern SVG to main SVG defs (with namespaced IDs)
                    // Only add if not already present (to avoid duplicates)
                    const sourceDefs = sourceSvg.querySelector('defs');
                    if (sourceDefs) {
                        Array.from(sourceDefs.children).forEach(defChild => {
                            // Check if this def already exists (by checking if an element with the namespaced ID exists)
                            const uniqueId = uniqueIdPrefix + (defChild.id || '');
                            if (!defs.querySelector(`#${uniqueId}`)) {
                                const clonedDef = defChild.cloneNode(true);
                                defs.appendChild(clonedDef);
                            }
                        });
                    }
                    
                    // Copy all non-defs children from pattern SVG to the group
                    // Iterate through all children and clone non-defs elements
                    const childrenToClone = [];
                    Array.from(sourceSvg.children).forEach(child => {
                        const tagName = child.tagName ? child.tagName.toLowerCase() : '';
                        if (tagName !== 'defs' && tagName !== '') {
                            childrenToClone.push(child);
                        }
                    });
                    
                    // Clone and append children
                    childrenToClone.forEach(child => {
                        const cloned = child.cloneNode(true);
                        patternGroup.appendChild(cloned);
                    });
                    
                    // Debug: log if no content was added
                    if (patternGroup.children.length === 0) {
                        console.warn('Pattern group is empty after cloning. Source SVG children:', 
                            Array.from(sourceSvg.children).map(c => c.tagName));
                    }
                    
                    // Apply color if specified (use color property, fallback to tint for patterns)
                    const colorToApply = imageData.color || (imageData.isPattern ? (imageData.tint || patternColor) : null);
                    if (colorToApply && colorToApply !== '#ffffff') {
                        const filterId = `color-${imageData.id}`;
                        let filter = defs.querySelector(`#${filterId}`);
                        
                        // Always update the filter with the current color
                        if (filter) {
                            // Remove old filter and create new one
                            filter.remove();
                        }
                        
                        filter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
                        filter.setAttribute('id', filterId);
                        filter.setAttribute('x', '0%');
                        filter.setAttribute('y', '0%');
                        filter.setAttribute('width', '100%');
                        filter.setAttribute('height', '100%');
                        
                        const feColorMatrix = document.createElementNS('http://www.w3.org/2000/svg', 'feColorMatrix');
                        feColorMatrix.setAttribute('type', 'matrix');
                        const rgb = hexToRgb(colorToApply);
                        if (rgb) {
                            const r = rgb.r / 255;
                            const g = rgb.g / 255;
                            const b = rgb.b / 255;
                            // Color matrix to tint the pattern/image with the selected color
                            feColorMatrix.setAttribute('values', 
                                `${r} 0 0 0 0  0 ${g} 0 0 0  0 0 ${b} 0 0  0 0 0 1 0`);
                        }
                        filter.appendChild(feColorMatrix);
                        defs.appendChild(filter);
                        patternGroup.setAttribute('filter', `url(#${filterId})`);
                    } else {
                        // Remove filter if color is white or not set
                        patternGroup.removeAttribute('filter');
                    }
                    
                    currentImageElements.push(patternGroup);
                    svgViewer.appendChild(patternGroup);
                } else {
                    // Regular image handling (non-pattern)
                    const imageEl = document.createElementNS('http://www.w3.org/2000/svg', 'image');
                    
                    // Set image source
                    if (imageData.dataUrl) {
                        imageEl.setAttributeNS('http://www.w3.org/1999/xlink', 'href', imageData.dataUrl);
                    }
                    
                    imageEl.setAttribute('width', width);
                    imageEl.setAttribute('height', height);
                    imageEl.setAttribute('x', x);
                    imageEl.setAttribute('y', y);
                    imageEl.setAttribute('opacity', opacity);
                    imageEl.setAttribute('data-image-id', imageData.id);
                    
                    // Apply color if specified
                    const colorToApply = imageData.color;
                    if (colorToApply && colorToApply !== '#ffffff') {
                        const filterId = `color-${imageData.id}`;
                        let filter = defs.querySelector(`#${filterId}`);
                        
                        // Always update the filter with the current color
                        if (filter) {
                            filter.remove();
                        }
                        
                        filter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
                        filter.setAttribute('id', filterId);
                        filter.setAttribute('x', '0%');
                        filter.setAttribute('y', '0%');
                        filter.setAttribute('width', '100%');
                        filter.setAttribute('height', '100%');
                        
                        const feColorMatrix = document.createElementNS('http://www.w3.org/2000/svg', 'feColorMatrix');
                        feColorMatrix.setAttribute('type', 'matrix');
                        const rgb = hexToRgb(colorToApply);
                        if (rgb) {
                            const r = rgb.r / 255;
                            const g = rgb.g / 255;
                            const b = rgb.b / 255;
                            // Color matrix to tint the image with the selected color
                            feColorMatrix.setAttribute('values', 
                                `${r} 0 0 0 0  0 ${g} 0 0 0  0 0 ${b} 0 0  0 0 0 1 0`);
                        }
                        filter.appendChild(feColorMatrix);
                        defs.appendChild(filter);
                        imageEl.setAttribute('filter', `url(#${filterId})`);
                    } else {
                        // Remove filter if color is white or not set
                        imageEl.removeAttribute('filter');
                    }
                    
                    currentImageElements.push(imageEl);
                    svgViewer.appendChild(imageEl);
                }
            });
        }

        // Keep old function name for compatibility
        function applyImagesToModel() {
            applyImagesToSVG();
        }

        // UI Functions
        function toggleDropdown() {
            const menu = document.getElementById('vehicle-menu');
            const trigger = document.querySelector('.dropdown-trigger');
            const isOpen = menu.classList.toggle('open');
            trigger.classList.toggle('open', isOpen);
            trigger.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        }

        function selectVehicle(name, type) {
            state.vehicleName = name;
            state.vehicleType = type;
            document.getElementById('selected-vehicle').textContent = name;
            document.querySelectorAll('.vehicle-option').forEach(opt => opt.classList.remove('active'));
            event.target.closest('.vehicle-option').classList.add('active');
            document.getElementById('vehicle-menu').classList.remove('open');
            document.querySelector('.dropdown-trigger').classList.remove('open');
            
            // Load SVG template if available
            if (svgTemplates[name]) {
                loadSVGTemplate(svgTemplates[name]);
            } else {
                // Use default phone case
                loadSVGTemplate('phonecase.svg');
            }
        }

        // Color conversion functions
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function rgbToHex(r, g, b) {
            return "#" + [r, g, b].map(x => {
                const hex = Math.round(x).toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join("");
        }

        function rgbToCmyk(r, g, b) {
            r = r / 255;
            g = g / 255;
            b = b / 255;
            
            const k = 1 - Math.max(r, g, b);
            if (k === 1) {
                return { c: 0, m: 0, y: 0, k: 100 };
            }
            
            const c = ((1 - r - k) / (1 - k)) * 100;
            const m = ((1 - g - k) / (1 - k)) * 100;
            const y = ((1 - b - k) / (1 - k)) * 100;
            
            return {
                c: Math.round(c),
                m: Math.round(m),
                y: Math.round(y),
                k: Math.round(k * 100)
            };
        }

        function cmykToRgb(c, m, y, k) {
            c = c / 100;
            m = m / 100;
            y = y / 100;
            k = k / 100;
            
            const r = 255 * (1 - c) * (1 - k);
            const g = 255 * (1 - m) * (1 - k);
            const b = 255 * (1 - y) * (1 - k);
            
            return {
                r: Math.round(r),
                g: Math.round(g),
                b: Math.round(b)
            };
        }

        function getLuminance(r, g, b) {
            // Calculate relative luminance
            const [rs, gs, bs] = [r, g, b].map(val => {
                val = val / 255;
                return val <= 0.03928 ? val / 12.92 : Math.pow((val + 0.055) / 1.055, 2.4);
            });
            return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
        }

        function updateColorFromPicker(hexColor) {
            state.color = hexColor;
            updateColorUI(hexColor, null);
            // Update gradient inputs to default to selected color
            const gradientStart = document.getElementById('gradient-start');
            const gradientEnd = document.getElementById('gradient-end');
            if (gradientStart && gradientEnd) {
                gradientStart.value = hexColor;
                gradientEnd.value = hexColor;
                updateGradient();
            }
            updateCarColor();
        }

        function updateColorFromHex(hexValue) {
            // Validate and format hex color
            let hex = hexValue.trim();
            if (!hex.startsWith('#')) {
                hex = '#' + hex;
            }
            // Validate hex format (3 or 6 characters after #)
            if (/^#[0-9A-Fa-f]{3}$/.test(hex) || /^#[0-9A-Fa-f]{6}$/.test(hex)) {
                state.color = hex;
                updateColorUI(hex, null, true);
                // Update gradient inputs to default to selected color
                const gradientStart = document.getElementById('gradient-start');
                const gradientEnd = document.getElementById('gradient-end');
                if (gradientStart && gradientEnd) {
                    gradientStart.value = hex;
                    gradientEnd.value = hex;
                    updateGradient();
                }
                updateCarColor();
            }
        }

        function updateColorFromCMYK() {
            const c = parseInt(document.getElementById('cmyk-c').value) || 0;
            const m = parseInt(document.getElementById('cmyk-m').value) || 0;
            const y = parseInt(document.getElementById('cmyk-y').value) || 0;
            const k = parseInt(document.getElementById('cmyk-k').value) || 0;
            
            const rgb = cmykToRgb(c, m, y, k);
            const hex = rgbToHex(rgb.r, rgb.g, rgb.b);
            
            state.color = hex;
            updateColorUI(hex, null, false); // Don't update CMYK inputs (we're setting from them)
            updateCarColor();
        }

        function updateColorUI(hexColor, activeElement, updateCMYK = true) {
            // Update color picker
            document.getElementById('color-picker').value = hexColor;
            
            // Update preview input
            const preview = document.getElementById('color-preview');
            preview.style.background = hexColor;
            preview.value = hexColor.toUpperCase();
            
            // Adjust text color for readability
            const rgb = hexToRgb(hexColor);
            if (rgb) {
                const luminance = getLuminance(rgb.r, rgb.g, rgb.b);
                preview.style.color = luminance > 0.5 ? '#000000' : '#ffffff';
            }
            
            // Update CMYK inputs if needed
            if (updateCMYK) {
                const rgb = hexToRgb(hexColor);
                if (rgb) {
                    const cmyk = rgbToCmyk(rgb.r, rgb.g, rgb.b);
                    document.getElementById('cmyk-c').value = cmyk.c;
                    document.getElementById('cmyk-m').value = cmyk.m;
                    document.getElementById('cmyk-y').value = cmyk.y;
                    document.getElementById('cmyk-k').value = cmyk.k;
                }
            }
            
            // Update active swatch
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
            if (activeElement) {
                activeElement.classList.add('active');
            } else {
                // Find matching swatch by comparing hex values
                const swatches = document.querySelectorAll('.color-swatch');
                const targetRgb = hexToRgb(hexColor);
                if (targetRgb) {
                    swatches.forEach(swatch => {
                        const bgColor = swatch.style.background;
                        // Handle rgb() format
                        const rgbMatch = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                        if (rgbMatch) {
                            const swatchR = parseInt(rgbMatch[1]);
                            const swatchG = parseInt(rgbMatch[2]);
                            const swatchB = parseInt(rgbMatch[3]);
                            // Allow small tolerance for color matching
                            if (Math.abs(swatchR - targetRgb.r) < 3 &&
                                Math.abs(swatchG - targetRgb.g) < 3 &&
                                Math.abs(swatchB - targetRgb.b) < 3) {
                                swatch.classList.add('active');
                            }
                        } else {
                            // Handle hex format
                            const hexMatch = bgColor.match(/#[0-9a-fA-F]{6}/);
                            if (hexMatch && hexMatch[0].toLowerCase() === hexColor.toLowerCase()) {
                                swatch.classList.add('active');
                            }
                        }
                    });
                }
            }
        }

        function setColor(color, element) {
            console.log('setColor called:', color);
            state.color = color;
            state.isGradient = false;
            updateColorUI(color, element);
            // Update gradient inputs to default to selected color
            const gradientStart = document.getElementById('gradient-start');
            const gradientEnd = document.getElementById('gradient-end');
            if (gradientStart && gradientEnd) {
                gradientStart.value = color;
                gradientEnd.value = color;
                updateGradient();
            }
            // Update the SVG color
            updateCarColor();
        }

        function setGradient(gradient, element) {
            console.log('setGradient called:', gradient);
            state.color = gradient;
            state.isGradient = true;
            // Update active swatch
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            // Update color preview
            const colorPreview = document.getElementById('color-preview');
            if (colorPreview) {
                colorPreview.value = gradient;
                colorPreview.style.background = gradient;
            }
            // Update the SVG color
            updateCarColor();
        }

        function updateGradient() {
            const startColor = document.getElementById('gradient-start').value;
            const endColor = document.getElementById('gradient-end').value;
            const gradient = `linear-gradient(135deg, ${startColor}, ${endColor})`;
            const preview = document.getElementById('gradient-preview');
            if (preview) {
                preview.style.background = gradient;
            }
        }

        function applyCustomGradient() {
            const startColor = document.getElementById('gradient-start').value;
            const endColor = document.getElementById('gradient-end').value;
            const gradient = `linear-gradient(135deg, ${startColor}, ${endColor})`;
            setGradient(gradient, null);
            // Update active swatch
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
        }

        function handleFileUpload(event) {
            const newFiles = Array.from(event.target.files);
            const availableSlots = 5 - state.files.length;
            
            if (newFiles.length > availableSlots) {
                alert(`You can only upload ${availableSlots} more file(s). Maximum is 5 files.`);
                newFiles.splice(availableSlots);
            }
            
            newFiles.forEach(file => {
                if (state.files.length < 5 && file.type.startsWith('image/')) {
                    const fileId = Date.now() + Math.random();
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            uploadedImages.push({
                                id: fileId,
                                dataUrl: e.target.result,
                                width: img.width,
                                height: img.height,
                                file: file,
                                color: '#ffffff' // Initialize with white (no tint)
                            });
                            
                            state.files.push({
                                name: file.name,
                                id: fileId
                            });
                            
                            renderFilesList();
                            updatePricing();
                            applyImagesToSVG();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else if (state.files.length < 5) {
                    // Non-image files (like PDF) - just store metadata
                    state.files.push({
                        name: file.name,
                        id: Date.now() + Math.random()
                    });
                    renderFilesList();
                    updatePricing();
                }
            });
            
            event.target.value = '';
        }

        // Add a preset SVG logo as if it was an uploaded image, so it can be positioned on the 2D object
        function addPresetLogo(key) {
            const preset = logoPresets[key];
            if (!preset) {
                console.warn('Unknown logo preset key:', key);
                return;
            }

            const availableSlots = 5 - state.files.length;
            if (availableSlots <= 0) {
                alert('You have reached the maximum of 5 files. Remove one to add another logo.');
                return;
            }

            const svgString = preset.svg.trim();
            const fileId = 'preset-' + key + '-' + (logoPresetCounter++);

            // Parse SVG to get dimensions
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgString, 'image/svg+xml');
            const svgElement = svgDoc.documentElement;
            
            // Get dimensions from viewBox or width/height attributes
            let width = 600, height = 400;
            const viewBox = svgElement.getAttribute('viewBox');
            if (viewBox) {
                const parts = viewBox.split(' ');
                if (parts.length >= 4) {
                    const parsedWidth = parseFloat(parts[2]);
                    const parsedHeight = parseFloat(parts[3]);
                    // Validate that parseFloat returned actual numbers before using them
                    if (!isNaN(parsedWidth) && isFinite(parsedWidth)) {
                        width = parsedWidth;
                    }
                    if (!isNaN(parsedHeight) && isFinite(parsedHeight)) {
                        height = parsedHeight;
                    }
                }
            } else {
                const parsedWidth = parseFloat(svgElement.getAttribute('width'));
                const parsedHeight = parseFloat(svgElement.getAttribute('height'));
                // Validate that parseFloat returned actual numbers before using them
                if (!isNaN(parsedWidth) && isFinite(parsedWidth)) {
                    width = parsedWidth;
                }
                if (!isNaN(parsedHeight) && isFinite(parsedHeight)) {
                    height = parsedHeight;
                }
            }

            // Store SVG string directly for patterns (not as blob URL)
            uploadedImages.push({
                id: fileId,
                dataUrl: null, // Will use svgContent instead
                svgContent: svgString, // Store the SVG string directly
                width: width,
                height: height,
                file: { name: preset.name },
                isPattern: true,
                tint: patternColor,
                color: patternColor, // Initialize with pattern color
                opacity: (typeof preset.opacity === 'number') ? preset.opacity : null
            });

            state.files.push({
                name: preset.name + ' (preset)',
                id: fileId
            });

            renderFilesList();
            updatePricing();
            applyImagesToSVG();
        }

        function renderFilesList() {
            const listEl = document.getElementById('files-list');
            if (state.files.length === 0) {
                listEl.innerHTML = '';
                return;
            }
            
            // Clear and rebuild list
            listEl.innerHTML = '';
            
            state.files.forEach((file, index) => {
                const imageData = uploadedImages.find(img => String(img.id) === String(file.id));
                const isImage = imageData !== undefined;
                const isPositioning = String(positioningImageId) === String(file.id);
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                if (isPositioning) {
                    fileItem.style.border = '2px solid #9333ea';
                    fileItem.style.background = 'rgba(147, 51, 234, 0.12)';
                }
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-info';
                fileInfo.innerHTML = `
                    <div class="file-icon">${isImage ? 'ðŸ–¼ï¸' : 'ðŸ“„'}</div>
                    <div class="file-name">${file.name}</div>
                `;
                fileItem.appendChild(fileInfo);
                
                const actionsDiv = document.createElement('div');
                actionsDiv.style.cssText = 'display: flex; gap: 0.5rem; align-items: center;';
                
                if (isImage) {
                    // Color picker for patterns/images
                    const colorInputWrapper = document.createElement('div');
                    colorInputWrapper.style.cssText = 'position: relative; display: flex; align-items: center;';
                    
                    // Initialize color if not set
                    if (!imageData.color) {
                        imageData.color = imageData.isPattern ? (imageData.tint || '#ffffff') : '#ffffff';
                    }
                    
                    const colorInput = document.createElement('input');
                    colorInput.type = 'color';
                    colorInput.value = imageData.color;
                    colorInput.title = 'Change color';
                    colorInput.style.cssText = `
                        width: 28px;
                        height: 28px;
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 0.375rem;
                        cursor: pointer;
                        background: transparent;
                        padding: 0;
                        -webkit-appearance: none;
                        -moz-appearance: none;
                        appearance: none;
                    `;
                    colorInput.addEventListener('change', (e) => {
                        e.stopPropagation();
                        if (imageData) {
                            imageData.color = e.target.value;
                            if (imageData.isPattern) {
                                imageData.tint = e.target.value;
                            }
                            applyImagesToSVG();
                        }
                    });
                    colorInputWrapper.appendChild(colorInput);
                    actionsDiv.appendChild(colorInputWrapper);
                    
                    const positionBtn = document.createElement('button');
                    positionBtn.className = 'file-position';
                    positionBtn.title = 'Position on object';
                    positionBtn.textContent = 'ðŸŽ¯';
                    positionBtn.style.cssText = `
                        width: 28px;
                        height: 28px;
                        background: ${isPositioning ? 'rgba(147, 51, 234, 0.25)' : 'rgba(147, 51, 234, 0.12)'};
                        border: 1px solid rgba(147, 51, 234, 0.3);
                        border-radius: 0.375rem;
                        color: #9333ea;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1rem;
                        line-height: 1;
                        transition: all 0.2s;
                    `;
                    positionBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        startImagePositioning(file.id);
                    });
                    actionsDiv.appendChild(positionBtn);
                    
                    if (isPositioning) {
                        const stopBtn = document.createElement('button');
                        stopBtn.className = 'file-position-stop';
                        stopBtn.title = 'Stop positioning';
                        stopBtn.textContent = 'âœ•';
                        stopBtn.style.cssText = `
                            width: 28px;
                            height: 28px;
                            background: rgba(239, 68, 68, 0.15);
                            border: 1px solid rgba(239, 68, 68, 0.3);
                            border-radius: 0.375rem;
                            color: #ef4444;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 0.875rem;
                            line-height: 1;
                            transition: all 0.2s;
                        `;
                        stopBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            stopImagePositioning();
                        });
                        actionsDiv.appendChild(stopBtn);
                    }
                }
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'file-delete';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDeleteConfirmation(index);
                });
                actionsDiv.appendChild(deleteBtn);
                
                fileItem.appendChild(actionsDiv);
                listEl.appendChild(fileItem);
            });
        }

        function showDeleteConfirmation(index) {
            fileToDelete = index;
            document.getElementById('delete-modal').classList.add('show');
        }

        function cancelDelete() {
            fileToDelete = null;
            document.getElementById('delete-modal').classList.remove('show');
        }

        function confirmDelete() {
            if (fileToDelete !== null) {
                const deletedFile = state.files[fileToDelete];
                
                // Stop positioning if deleting the file being positioned
                if (positioningImageId === deletedFile.id) {
                    stopImagePositioning();
                }
                
                state.files.splice(fileToDelete, 1);
                
                // Remove corresponding image
                uploadedImages = uploadedImages.filter(img => img.id !== deletedFile.id);
                
                fileToDelete = null;
                renderFilesList();
                updatePricing();
                applyImagesToModel();
            }
            document.getElementById('delete-modal').classList.remove('show');
        }



        function updateFinish(finish) {
            state.finish = finish;
            // Update visual styling based on finish (could affect material properties)
            updateCarColor();
        }


        // Pattern color controls removed - individual color pickers are now used per pattern

        function updatePatternColor(color) {
            patternColor = color || '#ffffff';

            // Update tint on all pattern images and re-apply
            uploadedImages.forEach(img => {
                if (img.isPattern) {
                    img.tint = patternColor;
                }
            });

            applyImagesToSVG();
        }

        function incrementQuantity() {
            if (state.quantity < 20) {
                state.quantity++;
                document.getElementById('quantity').textContent = state.quantity;
                updatePricing();
            }
        }

        function decrementQuantity() {
            if (state.quantity > 1) {
                state.quantity--;
                document.getElementById('quantity').textContent = state.quantity;
                updatePricing();
            }
        }

        function togglePriceBreakdown() {
            const breakdown = document.getElementById('price-breakdown');
            const arrow = document.getElementById('breakdown-arrow');
            const text = document.getElementById('breakdown-text');
            const button = document.querySelector('.price-details-toggle');
            
            const isOpen = breakdown.classList.toggle('open');
            button.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            
            if (isOpen) {
                arrow.textContent = 'â–²';
                text.textContent = 'Hide breakdown';
            } else {
                arrow.textContent = 'â–¼';
                text.textContent = 'Show breakdown';
            }
        }

        function updatePricing() {
            const basePrice = 20;
            const filesPrice = state.files.length * 1;

            const perVehicle = basePrice + filesPrice;
            const total = perVehicle * state.quantity;

            document.getElementById('base-price').textContent = '$' + basePrice;
            
            document.getElementById('files-line').style.display = state.files.length > 0 ? 'flex' : 'none';
            document.getElementById('file-count').textContent = state.files.length;
            document.getElementById('files-price').textContent = '$' + filesPrice;
            
            document.getElementById('quantity-display').textContent = state.quantity;
            document.getElementById('plural-s').textContent = state.quantity > 1 ? 's' : '';
            document.getElementById('total-price').textContent = '$' + total.toLocaleString();
        }

        // Order Preview Functions
        function openOrderPreview() {
            const overlay = document.getElementById('order-preview-overlay');
            const modal = overlay.querySelector('.order-preview-modal');
            
            // Update order details
            updateOrderPreviewDetails();
            
            // Clone SVG preview
            cloneSVGPreview();
            
            // Show modal
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeOrderPreview() {
            const overlay = document.getElementById('order-preview-overlay');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        }

        function updateOrderPreviewDetails() {
            const basePrice = 20;
            const filesPrice = state.files.length * 1;
            const perVehicle = basePrice + filesPrice;
            const total = perVehicle * state.quantity;

            // Update product name
            document.getElementById('order-preview-product').textContent = state.vehicleName || 'Phone Case';
            
            // Update quantity
            document.getElementById('order-preview-quantity').textContent = state.quantity;
            
            // Update finish
            const finishCapitalized = state.finish.charAt(0).toUpperCase() + state.finish.slice(1);
            document.getElementById('order-preview-finish').textContent = finishCapitalized;
            
            // Update files count
            const filesItem = document.getElementById('order-preview-files-item');
            const filesLine = document.getElementById('order-preview-files-line');
            if (state.files.length > 0) {
                filesItem.style.display = 'flex';
                filesLine.style.display = 'flex';
                document.getElementById('order-preview-files-count').textContent = state.files.length;
                document.getElementById('order-preview-file-count').textContent = state.files.length;
                document.getElementById('order-preview-files-price').textContent = '$' + filesPrice;
            } else {
                filesItem.style.display = 'none';
                filesLine.style.display = 'none';
            }
            
            // Update pricing
            document.getElementById('order-preview-base-price').textContent = '$' + basePrice;
            document.getElementById('order-preview-total-price').textContent = '$' + total.toLocaleString();
        }

        function cloneSVGPreview() {
            const sourceSVG = document.getElementById('svg-viewer');
            const targetSVG = document.getElementById('order-preview-svg');
            
            if (!sourceSVG || !targetSVG) {
                return;
            }
            
            // Clone using innerHTML for better compatibility with SVG content
            // This preserves all elements, attributes, and data URLs
            const clonedContent = sourceSVG.innerHTML;
            targetSVG.innerHTML = clonedContent;
            
            // Copy viewBox and other attributes
            if (sourceSVG.hasAttribute('viewBox')) {
                targetSVG.setAttribute('viewBox', sourceSVG.getAttribute('viewBox'));
            }
            
            // Copy preserveAspectRatio
            if (sourceSVG.hasAttribute('preserveAspectRatio')) {
                targetSVG.setAttribute('preserveAspectRatio', sourceSVG.getAttribute('preserveAspectRatio'));
            }
            
            // Copy width and height if present
            if (sourceSVG.hasAttribute('width')) {
                targetSVG.setAttribute('width', sourceSVG.getAttribute('width'));
            }
            if (sourceSVG.hasAttribute('height')) {
                targetSVG.setAttribute('height', sourceSVG.getAttribute('height'));
            }
        }

        function proceedToCheckout() {
            // This function can be extended to proceed to the next step of checkout
            // For now, we'll just show an alert or you can redirect to a checkout page
            alert('Proceeding to checkout...\n\nThis would typically redirect to a checkout page with order details.');
            // Uncomment below to redirect:
            // window.location.href = '/checkout';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.querySelector('.vehicle-dropdown');
            if (!dropdown.contains(e.target)) {
                document.getElementById('vehicle-menu').classList.remove('open');
                document.querySelector('.dropdown-trigger').classList.remove('open');
            }
        });

        // Close modal on overlay click
        document.getElementById('delete-modal').addEventListener('click', (e) => {
            if (e.target.id === 'delete-modal') {
                cancelDelete();
            }
        });

        // ESC key to stop image positioning or close order preview
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close order preview if open
                const overlay = document.getElementById('order-preview-overlay');
                if (overlay && overlay.classList.contains('show')) {
                    closeOrderPreview();
                    return;
                }
                // Stop image positioning if active
                if (isPositioning) {
                    stopImagePositioning();
                }
            }
        });

        // Global error handling for browser extensions and unhandled promises
        window.addEventListener('error', function(e) {
            // Ignore errors from browser extensions (giveFreely, etc.)
            if (e.filename && (e.filename.includes('extension://') || e.filename.includes('giveFreely'))) {
                e.preventDefault();
                return true;
            }
            // Also check error message for giveFreely references
            if (e.message && typeof e.message === 'string' && e.message.includes('giveFreely')) {
                e.preventDefault();
                return true;
            }
        }, true);
        
        window.addEventListener('unhandledrejection', function(e) {
            // Suppress unhandled promise rejections from browser extensions
            try {
                // Check if reason exists and contains giveFreely reference
                if (e.reason) {
                    const reasonStr = e.reason.toString ? e.reason.toString() : String(e.reason);
                    if (reasonStr.includes('giveFreely')) {
                        e.preventDefault();
                        return true;
                    }
                }
                // Also check error message in the rejection event
                if (e.message && typeof e.message === 'string' && e.message.includes('giveFreely')) {
                    e.preventDefault();
                    return true;
                }
                // Check for payload-related errors from extensions
                if (e.reason && typeof e.reason === 'object' && e.reason.message) {
                    const errorMsg = String(e.reason.message);
                    if (errorMsg.includes('payload') || errorMsg.includes('giveFreely')) {
                        e.preventDefault();
                        return true;
                    }
                }
            } catch (err) {
                // Silently ignore errors in error handler to prevent infinite loops
            }
        });

        // Initialize pricing (2D viewer is handled by SVG rendering)
        updatePricing();
        
        // Initialize color UI with default color
        updateColorUI('#f5f5f5', document.querySelector('.color-swatch.active'));
        
        // Hydrate Lucide icons once DOM and scripts are ready
        if (window.lucide && typeof window.lucide.createIcons === 'function') {
            window.lucide.createIcons();
        }
        
        // Ensure modal is hidden on page load
        const modal = document.getElementById('delete-modal');
        if (modal) {
            modal.setAttribute('aria-hidden', 'true');
            modal.classList.remove('show');
        }

        // Initialize SVG viewer so patterns/images can be positioned on the 2D object
        initSVGViewer();
    </script>
</body>
</html>